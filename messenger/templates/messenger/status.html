<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lote #{{ batch.id }} ‚Äî WhatsApp CHARLIE CROSS BOT ü§ñ</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2325D366'><path d='M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z'/></svg>">
</head>

<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <a href="{% url 'upload' %}" class="back-link" title="Volver al Panel">
                    <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
                    </svg>
                </a>
                <h1>Lote #{{ batch.id }}</h1>
            </div>
            <span class="batch-file">{{ batch.excel_filename }}</span>
        </header>

        <main class="main">
            <div class="status-overview">
                <div class="progress-card">
                    <div class="progress-header">
                        <h2>üìä Progreso de Env√≠o</h2>
                        <span class="status-badge status-{{ batch.status }}" id="batchStatus">{{ batch.status }}</span>
                    </div>

                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar" style="width: {{ batch.progress_percent }}%"></div>
                    </div>

                    <div class="progress-stats">
                        <div class="stat">
                            <span class="stat-value" id="sentCount">{{ batch.sent_count }}</span>
                            <span class="stat-label">Enviados</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" id="failedCount" style="color: var(--danger);">{{ batch.failed_count }}</span>
                            <span class="stat-label">Fallidos</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" id="pendingCount" style="color: var(--warning);">{{ batch.total_messages|add:"-"|add:batch.sent_count|add:"-"|add:batch.failed_count }}</span>
                            <span class="stat-label">Pendientes</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" style="color: var(--text-secondary);">{{ batch.total_messages }}</span>
                            <span class="stat-label">Total</span>
                        </div>
                    </div>

                    <div class="action-buttons">
                        {% if batch.status == 'pending' %}
                        <button class="btn btn-primary btn-large" id="startBtn" onclick="startSending()">
                            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                                <path d="M8 5v14l11-7z" />
                            </svg>
                            Iniciar Env√≠o
                        </button>
                        {% elif batch.status == 'running' %}
                        <button class="btn btn-danger btn-large" id="stopBtn" onclick="stopSending()">
                            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                                <path d="M6 6h12v12H6z" />
                            </svg>
                            Detener Env√≠o
                        </button>
                        {% endif %}

                        <a href="{% url 'upload' %}" class="btn btn-secondary">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                            </svg>
                            Nuevo Lote
                        </a>
                    </div>
                </div>

                {% if batch.status == 'running' %}
                <div class="alert alert-info">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
                    </svg>
                    <div>
                        <strong>üåê Navegador Chrome Abierto</strong><br>
                        Por favor escanea el c√≥digo QR en WhatsApp Web si se solicita. Los mensajes comenzar√°n a enviarse autom√°ticamente una vez conectado.
                    </div>
                </div>
                {% endif %}

                {% if batch.status == 'completed' %}
                <div class="alert" style="background: var(--success-bg); border: 1px solid rgba(37, 211, 102, 0.25); color: var(--success);">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                    <div>
                        <strong>‚úÖ Lote Completado</strong><br>
                        Todos los mensajes han sido procesados. {{ batch.sent_count }} enviados correctamente{% if batch.failed_count > 0 %}, {{ batch.failed_count }} fallidos{% endif %}.
                    </div>
                </div>
                {% endif %}

                {% if batch.status == 'failed' and batch.sent_count == 0 %}
                <div class="alert alert-error">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                    <div>
                        <strong>‚ùå Lote Fallido</strong><br>
                        El lote fue detenido o fall√≥ antes de completarse. Revisa los mensajes de error abajo.
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="messages-card">
                <h3>üì® Mensajes ({{ messages|length }})</h3>
                <div class="messages-list" id="messagesList">
                    {% for message in messages %}
                    <div class="message-item" id="message-{{ message.id }}">
                        <div class="message-status status-{{ message.status }}">
                            {% if message.status == 'sent' %}
                            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                            </svg>
                            {% elif message.status == 'failed' %}
                            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                            </svg>
                            {% elif message.status == 'sending' %}
                            <div class="spinner"></div>
                            {% else %}
                            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/>
                            </svg>
                            {% endif %}
                        </div>
                        <div class="message-info">
                            <span class="message-phone">{{ message.phone_number }}</span>
                            <span class="message-preview">{{ message.message_text|truncatewords:12 }}</span>
                            {% if message.attachment_filename %}
                            <span class="message-attachment">üìé {{ message.attachment_filename }}</span>
                            {% endif %}
                        </div>
                        <div class="message-meta">
                            <span class="message-status-text">{{ message.status }}</span>
                            {% if message.error_message %}
                            <span class="message-error" title="{{ message.error_message }}">Ver Error</span>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <p>No hay mensajes en este lote</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </main>
    </div>

    <script>
        const batchId = {{ batch.id }};
        let refreshInterval = null;

        function updateStatus() {
            fetch(`/api/status/${batchId}/`)
                .then(response => response.json())
                .then(data => {
                    // Update progress bar with smooth animation
                    const progressBar = document.getElementById('progressBar');
                    progressBar.style.width = data.batch.progress_percent + '%';
                    
                    // Update counts
                    document.getElementById('sentCount').textContent = data.batch.sent_count;
                    document.getElementById('failedCount').textContent = data.batch.failed_count;

                    const pending = data.batch.total_messages - data.batch.sent_count - data.batch.failed_count;
                    document.getElementById('pendingCount').textContent = pending;

                    // Update batch status badge
                    const statusBadge = document.getElementById('batchStatus');
                    statusBadge.textContent = data.batch.status;
                    statusBadge.className = 'status-badge status-' + data.batch.status;

                    // Update message statuses
                    data.messages.forEach(msg => {
                        const elem = document.getElementById('message-' + msg.id);
                        if (elem) {
                            const statusDiv = elem.querySelector('.message-status');
                            statusDiv.className = 'message-status status-' + msg.status;

                            // Update icon based on status
                            if (msg.status === 'sent') {
                                statusDiv.innerHTML = '<svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" /></svg>';
                            } else if (msg.status === 'failed') {
                                statusDiv.innerHTML = '<svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" /></svg>';
                            } else if (msg.status === 'sending') {
                                statusDiv.innerHTML = '<div class="spinner"></div>';
                            }

                            const statusText = elem.querySelector('.message-status-text');
                            statusText.textContent = msg.status;

                            // Add error badge if there's an error
                            const metaDiv = elem.querySelector('.message-meta');
                            if (msg.error && !metaDiv.querySelector('.message-error')) {
                                const errorSpan = document.createElement('span');
                                errorSpan.className = 'message-error';
                                errorSpan.title = msg.error;
                                errorSpan.textContent = 'Ver Error';
                                metaDiv.appendChild(errorSpan);
                            }
                        }
                    });

                    // Stop refreshing if completed or failed
                    if (data.batch.status === 'completed' || data.batch.status === 'failed') {
                        if (refreshInterval) {
                            clearInterval(refreshInterval);
                            refreshInterval = null;
                        }
                        // Reload to update UI (buttons, alerts)
                        setTimeout(() => location.reload(), 1000);
                    }
                })
                .catch(err => console.error('Status update failed:', err));
        }

        function startSending() {
            const btn = document.getElementById('startBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Iniciando...';

            fetch(`/api/start/${batchId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Start polling for updates
                        refreshInterval = setInterval(updateStatus, 2500);
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                        btn.disabled = false;
                        btn.innerHTML = '<svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M8 5v14l11-7z"/></svg> Iniciar Env√≠o';
                    }
                })
                .catch(err => {
                    alert('Error al iniciar: ' + err);
                    btn.disabled = false;
                });
        }

        function stopSending() {
            if (!confirm('¬øEst√°s seguro de que deseas detener el env√≠o? Los mensajes restantes se marcar√°n como fallidos.')) return;

            const btn = document.getElementById('stopBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Deteniendo...';

            fetch(`/api/stop/${batchId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    location.reload();
                })
                .catch(err => {
                    alert('Error al detener: ' + err);
                    btn.disabled = false;
                });
        }

        // Auto-refresh if batch is running
        {% if batch.status == 'running' %}
        refreshInterval = setInterval(updateStatus, 2500);
        // Also do an immediate update
        setTimeout(updateStatus, 500);
        {% endif %}
    </script>
</body>

</html>
