<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp BOT ðŸ¤– â€” Panel</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2325D366'><path d='M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z'/></svg>">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <svg viewBox="0 0 24 24" width="42" height="42" fill="currentColor">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                </svg>
                <h1>WhatsApp CHARLIE CROSS BOT ðŸ¤–</h1>
            </div>
            <a href="{% url 'download_template' %}" class="btn btn-secondary">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
                Descargar Plantilla
            </a>
        </header>

        <main class="main">
            {% if error %}
            <div class="alert alert-error">
                <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor" style="flex-shrink: 0;">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                <div style="flex: 1;">
                    <strong>Error de Carga</strong><br>
                    {{ error }}
                    
                    {% if missing_attachments %}
                    <div class="missing-files-section" style="margin-top: 16px;">
                        <p style="margin-bottom: 10px; font-weight: 600; color: #fca5a5;">Archivos faltantes:</p>
                        <ul style="margin: 0; padding-left: 20px; font-size: 0.9rem;">
                            {% for filename in missing_attachments %}
                            <li style="margin-bottom: 4px;"><code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px;">{{ filename }}</code></li>
                            {% endfor %}
                        </ul>
                        
                        {% if missing_details %}
                        <p style="margin-top: 14px; margin-bottom: 8px; font-weight: 600; color: #fca5a5;">Filas afectadas en Excel:</p>
                        <div style="max-height: 150px; overflow-y: auto; font-size: 0.85rem;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                        <th style="text-align: left; padding: 6px 8px; font-weight: 600;">Fila</th>
                                        <th style="text-align: left; padding: 6px 8px; font-weight: 600;">TelÃ©fono</th>
                                        <th style="text-align: left; padding: 6px 8px; font-weight: 600;">Archivo Faltante</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for detail in missing_details %}
                                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                        <td style="padding: 6px 8px;">{{ detail.row }}</td>
                                        <td style="padding: 6px 8px; font-family: monospace;">{{ detail.phone }}</td>
                                        <td style="padding: 6px 8px;"><code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px;">{{ detail.filename }}</code></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}
                        
                        {% if uploaded_files %}
                        <details style="margin-top: 14px;">
                            <summary style="cursor: pointer; font-weight: 600; color: #a1a1aa;">Ver archivos subidos ({{ uploaded_files|length }})</summary>
                            <ul style="margin-top: 8px; padding-left: 20px; font-size: 0.85rem; color: #a1a1aa;">
                                {% for filename in uploaded_files %}
                                <li style="margin-bottom: 2px;">{{ filename }}</li>
                                {% endfor %}
                            </ul>
                        </details>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <div class="upload-card">
                <h2>ðŸ“¤ Subir Mensajes</h2>
                <p class="subtitle">Sube tu archivo Excel con mensajes y archivos adjuntos opcionales para iniciar el envÃ­o masivo</p>
                
                <form method="post" enctype="multipart/form-data" id="uploadForm">
                    {% csrf_token %}
                    
                    <div class="form-group">
                        <label for="excel_file">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="vertical-align: middle; margin-right: 6px; opacity: 0.7;">
                                <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
                            </svg>
                            Archivo Excel (.xlsx)
                        </label>
                        <div class="file-drop-zone" id="excelDropZone">
                            <input type="file" name="excel_file" id="excel_file" accept=".xlsx,.xls" required>
                            <div class="drop-content">
                                <svg viewBox="0 0 24 24" width="52" height="52" fill="currentColor">
                                    <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11zM8 15.01l1.41 1.41L11 14.84V19h2v-4.16l1.59 1.59L16 15.01 12.01 11 8 15.01z"/>
                                </svg>
                                <p>Arrastra y suelta tu archivo Excel aquÃ­</p>
                                <span>o haz clic en cualquier lugar para buscar</span>
                            </div>
                            <div class="file-selected" id="excelSelected" style="display: none;">
                                <svg viewBox="0 0 24 24" width="26" height="26" fill="currentColor">
                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                                </svg>
                                <span id="excelFileName"></span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="attachments">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="vertical-align: middle; margin-right: 6px; opacity: 0.7;">
                                <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/>
                            </svg>
                            Archivos Adjuntos (opcional)
                        </label>
                        <div class="file-drop-zone" id="attachDropZone">
                            <!-- Input oculto para archivos individuales -->
                            <input type="file" name="attachments" id="attachments" multiple style="display: none;">
                            <!-- Input oculto para carpetas -->
                            <input type="file" id="attachmentsFolder" webkitdirectory multiple style="display: none;">
                            <div class="drop-content">
                                <svg viewBox="0 0 24 24" width="52" height="52" fill="currentColor">
                                    <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/>
                                </svg>
                                <p>Arrastra y suelta archivos o una carpeta aquÃ­</p>
                                <span>O haz clic en un botÃ³n para buscar</span>
                                <div class="browse-buttons" style="display: flex; gap: 12px; margin-top: 16px;">
                                    <button type="button" id="browseFilesBtn" class="btn btn-secondary" style="padding: 10px 20px; font-size: 0.85rem;">
                                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                            <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
                                        </svg>
                                        Seleccionar Archivos
                                    </button>
                                    <button type="button" id="browseFolderBtn" class="btn btn-secondary" style="padding: 10px 20px; font-size: 0.85rem;">
                                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                            <path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
                                        </svg>
                                        Seleccionar Carpeta
                                    </button>
                                </div>
                            </div>
                            <div class="file-selected" id="attachSelected" style="display: none;">
                                <svg viewBox="0 0 24 24" width="26" height="26" fill="currentColor">
                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                                </svg>
                                <span id="attachFileCount"></span>
                                <button type="button" id="clearAttachBtn" class="btn btn-secondary" style="padding: 6px 14px; font-size: 0.8rem; margin-left: 12px;">Limpiar</button>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-large" style="width: 100%;">
                        <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                        </svg>
                        Subir y Previsualizar Mensajes
                    </button>
                </form>
            </div>

            <div class="info-card">
                <h3>ðŸ“‹ GuÃ­a de Formato Excel</h3>
                <table class="format-table">
                    <thead>
                        <tr>
                            <th>Columna A</th>
                            <th>Columna B</th>
                            <th>Columna C</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>NÃºmero de TelÃ©fono</strong></td>
                            <td><strong>Texto del Mensaje</strong></td>
                            <td><strong>Nombre del Archivo</strong></td>
                        </tr>
                        <tr>
                            <td>5512345678</td>
                            <td>Â¡Hola! Tu pedido estÃ¡ listo para recoger.</td>
                            <td>factura.pdf</td>
                        </tr>
                        <tr>
                            <td>5587654321</td>
                            <td>Â¡Hola! AquÃ­ estÃ¡ tu recibo adjunto.</td>
                            <td>recibo.jpg</td>
                        </tr>
                    </tbody>
                </table>
                <p class="note">
                    ðŸ“± Los nÃºmeros sin cÃ³digo de paÃ­s usarÃ¡n automÃ¡ticamente +52 (MÃ©xico)
                </p>
            </div>

            {% if recent_batches %}
            <div class="recent-card">
                <h3>ðŸ“Š Lotes Recientes</h3>
                <div class="batch-list">
                    {% for batch in recent_batches %}
                    <a href="{% url 'status' batch.id %}" class="batch-item">
                        <div class="batch-info">
                            <span class="batch-name">{{ batch.excel_filename }}</span>
                            <span class="batch-date">{{ batch.created_at|date:"M d, Y â€” H:i" }}</span>
                        </div>
                        <div class="batch-status">
                            <span style="font-weight: 600;">{{ batch.sent_count }}/{{ batch.total_messages }}</span>
                            <span class="status-badge status-{{ batch.status }}">{{ batch.status }}</span>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </main>
    </div>

    <script>
        // Recursively read all files from a directory entry
        async function readDirectoryEntries(directoryEntry) {
            const files = [];
            const reader = directoryEntry.createReader();
            
            // Read entries in batches (readEntries returns max ~100 at a time)
            async function readAllEntries() {
                const entries = await new Promise((resolve, reject) => {
                    reader.readEntries(resolve, reject);
                });
                
                if (entries.length === 0) return;
                
                for (const entry of entries) {
                    if (entry.isFile) {
                        const file = await new Promise((resolve, reject) => {
                            entry.file(resolve, reject);
                        });
                        files.push(file);
                    } else if (entry.isDirectory) {
                        // Recursively read subdirectories
                        const subFiles = await readDirectoryEntries(entry);
                        files.push(...subFiles);
                    }
                }
                
                // Continue reading if there might be more entries
                await readAllEntries();
            }
            
            await readAllEntries();
            return files;
        }

        // Process dropped items and extract files from folders
        async function processDroppedItems(dataTransfer) {
            const files = [];
            const items = dataTransfer.items;
            let folderCount = 0;
            
            if (!items) {
                // Fallback for browsers without items API
                return { files: Array.from(dataTransfer.files), folderCount: 0 };
            }
            
            const entries = [];
            for (let i = 0; i < items.length; i++) {
                const entry = items[i].webkitGetAsEntry ? items[i].webkitGetAsEntry() : null;
                if (entry) {
                    entries.push(entry);
                } else {
                    // Fallback: get as file directly
                    const file = items[i].getAsFile();
                    if (file) files.push(file);
                }
            }
            
            for (const entry of entries) {
                if (entry.isDirectory) {
                    folderCount++;
                    const dirFiles = await readDirectoryEntries(entry);
                    files.push(...dirFiles);
                } else if (entry.isFile) {
                    const file = await new Promise((resolve, reject) => {
                        entry.file(resolve, reject);
                    });
                    files.push(file);
                }
            }
            
            return { files, folderCount };
        }

        // Create a DataTransfer object with files (to set on input)
        function createFileList(files) {
            const dataTransfer = new DataTransfer();
            files.forEach(file => dataTransfer.items.add(file));
            return dataTransfer.files;
        }

        // Simple drop zone for Excel file
        function setupExcelDropZone() {
            const zone = document.getElementById('excelDropZone');
            const input = document.getElementById('excel_file');
            const selected = document.getElementById('excelSelected');
            const fileName = document.getElementById('excelFileName');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                zone.addEventListener(eventName, e => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                zone.addEventListener(eventName, () => zone.classList.add('drag-over'));
            });

            ['dragleave', 'drop'].forEach(eventName => {
                zone.addEventListener(eventName, () => zone.classList.remove('drag-over'));
            });

            // The file input is positioned over the zone with CSS, so clicking the zone
            // naturally triggers the file input. No additional click handler needed.

            zone.addEventListener('drop', e => {
                input.files = e.dataTransfer.files;
                updateDisplay();
            });

            input.addEventListener('change', updateDisplay);

            function updateDisplay() {
                if (input.files.length > 0) {
                    zone.querySelector('.drop-content').style.display = 'none';
                    selected.style.display = 'flex';
                    fileName.textContent = input.files[0].name;
                } else {
                    zone.querySelector('.drop-content').style.display = 'flex';
                    selected.style.display = 'none';
                }
            }
        }

        // Attachments drop zone with folder support
        function setupAttachmentsDropZone() {
            const zone = document.getElementById('attachDropZone');
            const fileInput = document.getElementById('attachments');
            const folderInput = document.getElementById('attachmentsFolder');
            const selected = document.getElementById('attachSelected');
            const fileCount = document.getElementById('attachFileCount');
            const browseFilesBtn = document.getElementById('browseFilesBtn');
            const browseFolderBtn = document.getElementById('browseFolderBtn');
            const clearBtn = document.getElementById('clearAttachBtn');
            
            let extractedFromFolders = 0;
            let collectedFiles = [];

            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                zone.addEventListener(eventName, e => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                zone.addEventListener(eventName, () => zone.classList.add('drag-over'));
            });

            ['dragleave', 'drop'].forEach(eventName => {
                zone.addEventListener(eventName, () => zone.classList.remove('drag-over'));
            });

            // Handle drag & drop
            zone.addEventListener('drop', async e => {
                zone.classList.add('processing');
                
                try {
                    const { files, folderCount } = await processDroppedItems(e.dataTransfer);
                    extractedFromFolders = folderCount;
                    collectedFiles = files;
                    
                    if (files.length > 0) {
                        fileInput.files = createFileList(files);
                        updateDisplay();
                    } else {
                        alert('No se encontraron archivos. Por favor selecciona archivos o una carpeta con archivos.');
                    }
                } catch (err) {
                    console.error('Error processing dropped items:', err);
                    alert('Error al leer archivos. Por favor intenta de nuevo.');
                } finally {
                    zone.classList.remove('processing');
                }
            });

            // "Select Files" button
            browseFilesBtn.addEventListener('click', e => {
                e.stopPropagation();
                fileInput.click();
            });

            // "Select Folder" button
            browseFolderBtn.addEventListener('click', e => {
                e.stopPropagation();
                folderInput.click();
            });

            // Handle file input change
            fileInput.addEventListener('change', () => {
                extractedFromFolders = 0;
                collectedFiles = Array.from(fileInput.files);
                updateDisplay();
            });

            // Handle folder input change
            folderInput.addEventListener('change', () => {
                extractedFromFolders = 1;
                collectedFiles = Array.from(folderInput.files);
                // Copy files to the main input so they get submitted
                fileInput.files = createFileList(collectedFiles);
                updateDisplay();
            });

            // Clear button
            clearBtn.addEventListener('click', e => {
                e.stopPropagation();
                fileInput.value = '';
                folderInput.value = '';
                collectedFiles = [];
                extractedFromFolders = 0;
                updateDisplay();
            });

            function updateDisplay() {
                if (fileInput.files.length > 0) {
                    zone.querySelector('.drop-content').style.display = 'none';
                    selected.style.display = 'flex';
                    const count = fileInput.files.length;
                    let text = `${count} archivo${count > 1 ? 's' : ''} seleccionado${count > 1 ? 's' : ''}`;
                    if (extractedFromFolders > 0) {
                        text += ` (de ${extractedFromFolders} carpeta${extractedFromFolders > 1 ? 's' : ''})`;
                    }
                    fileCount.textContent = text;
                } else {
                    zone.querySelector('.drop-content').style.display = 'flex';
                    selected.style.display = 'none';
                }
            }
        }

        // Initialize drop zones
        setupExcelDropZone();
        setupAttachmentsDropZone();
    </script>
</body>
</html>
